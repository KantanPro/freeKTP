# KantanPro 本番環境マイグレーションガイド

## 概要

本番環境でKantanProプラグインをデプロイした際に、`ktp_order`テーブルに不足しているカラムを追加するためのマイグレーション方法を説明します。

## 不足しているカラム

以下のカラムが本番環境のテーブルに不足している可能性があります：

- `completion_date` (完了日) - `date DEFAULT NULL`
- `desired_delivery_date` (希望納期) - `date DEFAULT NULL`
- `expected_delivery_date` (予想納期) - `date DEFAULT NULL`
- `company_name` (会社名) - `varchar(255) COLLATE utf8mb4_unicode_520_ci DEFAULT NULL`

## マイグレーション方法

### 自動マイグレーション（唯一の方法）

マイグレーションは以下の場合のみ自動実行されます：

1. **プラグイン有効化時**: プラグインを有効化すると自動的にマイグレーションが実行されます
2. **プラグインアップデート時**: プラグインをアップデートすると自動的にマイグレーションが実行されます

### マイグレーション状態の確認

#### WordPress管理画面から確認

1. WordPressの管理画面にログイン
2. 「ツール」→「KTP マイグレーション」をクリック
3. 現在のテーブル状態を確認
4. マイグレーションログを確認

**注意**: 手動でのマイグレーション実行はできません。プラグインの有効化またはアップデートが必要です。

## 対応するテーブル接頭辞

このマイグレーションは以下のテーブル接頭辞に対応しています：

- `wp_` (WordPress標準)
- `to_` (本番環境)
- `xx_` (その他の環境)
- `ktp_`
- `kantan_`
- その他のカスタム接頭辞

## セキュリティ

- マイグレーションは自動実行のみで、手動実行はできません
- 自動マイグレーションは安全に実行され、ログファイルに記録されます
- すべての操作はWordPressのセキュリティ機能で保護されています

## ログ機能

マイグレーションの実行状況は以下の場所にログが記録されます：

- **ログファイル**: `wp-content/ktpwp-migration.log`
- **管理画面**: 「ツール」→「KTP マイグレーション」で最新のログを確認可能

## トラブルシューティング

### テーブルが見つからない場合

1. データベースに`ktp_order`テーブルが存在することを確認
2. テーブル名が正しいことを確認
3. データベース接続が正常であることを確認

### マイグレーションが失敗する場合

1. データベースの権限を確認
2. テーブルがロックされていないことを確認
3. 十分なディスク容量があることを確認

### エラーログの確認

WordPressのデバッグログを有効にして、詳細なエラー情報を確認できます：

```php
// wp-config.php
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
```

## 注意事項

- マイグレーションは一度だけ実行してください
- 実行中は他のデータベース操作を避けてください
- 本番環境での実行前に、必ずテスト環境で動作確認を行ってください

## サポート

マイグレーションで問題が発生した場合は、以下を確認してください：

1. WordPressのバージョン
2. PHPのバージョン
3. データベースの種類とバージョン
4. エラーログの内容

詳細な情報と共にサポートチームにお問い合わせください。 