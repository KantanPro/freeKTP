# KantanPro (KTPWP) - Version 1.2.0(preview)

WordPressで動作する業務管理・受注進捗・請求・顧客・サービス・協力会社・レポート・スタッフチャットまで一元管理できる多機能プラグイン。

---

## 説明
KantanProは、WordPress上で以下の業務を一元管理できる多機能プラグインです。

**主要機能：**
- **6つの管理タブ**（仕事リスト・伝票処理・顧客・サービス・協力会社・レポート）
- **受注案件の進捗管理**（7段階：受注→進行中→完了→請求→支払い→ボツ→見積中）
- **受注書・請求書の作成・編集・PDF保存**（個別・一括出力対応）
- **顧客・サービス・協力会社のマスター管理**（検索・ソート・ページネーション）
- **スタッフチャット**（自動スクロール・削除連動・AJAX送信・キーボードショートカット）
- **モバイル対応UI**（gap→margin対応、iOS/Android実機対応、タッチ操作最適化）
- **部署管理機能**（顧客ごとの部署・担当者管理）
- **利用規約管理機能**（同意ダイアログ・管理画面・バージョン管理・表示対象の最適化）
- **シンプル更新システム**（WordPress標準の更新システムに最適化）
- **セキュリティ機能**（XSS/CSRF/SQLi/権限管理/ファイル検証/ノンス/prepare文）
- **セッション管理最適化**（REST API・AJAX・内部リクエスト対応）
- **ページネーション機能**（全タブ・ポップアップ対応・一般設定連携）
- **ファイル添付機能**（ドラッグ&ドロップ・複数ファイル・自動クリーンアップ）
- **完了日自動設定機能**（進捗変更時の自動処理）
- **納期警告機能**（期限管理・アラート表示）
- **商品管理機能**（価格・数量・単位管理・データマイグレーション対応）
- **スタッフアバター表示機能**（ログイン中スタッフの可視化）
- **プラグインリファレンス機能**（包括的なヘルプシステム）
- **寄付機能**（Stripe決済・セキュアな決済処理・進捗管理・自動メール送信）
- **自動マイグレーション機能**（データベース更新の安定化）
- **データベース整合性チェック機能**（データ品質向上）
- **消費税対応機能**（軽減税率・税区分対応の強化）
- **パフォーマンス最適化機能**（キャッシュ・クエリ最適化・メモリ効率化）
- **協力会社職能選択の改善**（ページネーション・検索・ソート機能の強化）
- **アイコンのSVG化**（Material SymbolsからSVGアイコンへの完全移行）
- **進捗アイコンのSVG化**（仕事リストタブの進捗フィルターアイコンをSVG化）
- **消費税対応の改善**（税率計算・表示の最適化）
- **受注書のコスト項目更新処理の改善**（リアルタイム保存・値変更検知・エラーハンドリング強化）
- **受注書のコスト項目発注メールの改善**（適格請求書対応・詳細な税額内訳・計算根拠明示）
- **請求書プレビューが閉じない問題を修正**
- **パフォーマンスの向上**（キャッシュシステム最適化・データベースクエリ効率化・メモリ使用量最適化・画像最適化・JavaScript・CSS最適化・セッション管理最適化・Ajax通信最適化）
- **マイグレーション中にエラー解消**（データベース更新処理の安定化・エラーハンドリング強化）
- **利用規約の表示対象を修正**（より適切な対象への変更）
- **URL生成問題１−１の修正**（動的パーマリンク取得による環境非依存のURL生成）
- **モバイル表示の改善**（レスポンシブデザイン強化・タッチ操作最適化・モバイル専用UI改善）
- **更新チェック問題テスト**（更新システムの安定性向上・バグ修正・パフォーマンス最適化）
- **KantanPro License Managerプラグインの連携１−１**（ライセンス管理システムとの統合・ライセンス検証機能・ライセンス情報管理・レート制限機能・セキュアなAPI通信）
- **ダミーデータツール機能**（管理画面でのテストデータ作成・顧客・サービス・協力会社・受注データの一括生成）
- **レポート機能**（売上レポート・顧客レポート・サービスレポート・協力会社レポート・期間別分析・グラフ表示機能・データエクスポート機能・ライセンス認証連携）

---

## セキュリティ対策
- **SQLインジェクション防止**（prepare文・バインド変数）
- **XSS・CSRF対策**（サニタイズ・エスケープ・ノンス）
- **ファイルアップロード検証**（MIME型・サイズ制限）
- **権限管理・安全なDBアクセス**（ロールベースアクセス制御）
- **ノンス・トークンによるフォーム保護**（CSRF攻撃防止）
- **REST API制限**（ログインユーザーのみアクセス可能）
- **セッション管理最適化**（内部リクエスト・API呼び出し時の自動クローズ）
- **gap→margin対応によるUI崩れ防止**（iOS/Android実機対応）

---

## システム要件
* WordPress 5.0 以上（推奨：最新版）
* PHP 7.4 以上（推奨：PHP 8.0以上）
* MySQL 5.6 以上 または MariaDB 10.0 以上
* 推奨メモリ: 256MB 以上
* 推奨PHP拡張: GD（画像処理用）

---

## インストール
1. プラグインを `/wp-content/plugins/` にアップロード、または管理画面からインストール
2. プラグインを有効化（自動マイグレーションが実行されます）
3. 固定ページに `[ktpwp_all_tab]` を挿入
4. 管理画面「KantanPro」から基本設定を行ってください

---

## 基本的な使い方
1. **固定ページに `[ktpwp_all_tab]` を挿入**すると、6つのタブが表示されます
2. **各タブで顧客・サービス・協力会社・受注書・レポート等を管理**
3. **伝票編集時は「サービス選択」ポップアップから商品を追加**
4. **受注書・請求書はPDFで出力可能**（個別・一括対応）
5. **モバイルでも快適に操作可能**（レスポンシブデザイン）
6. **スタッフチャットでリアルタイムコミュニケーション**（Ctrl+Enter送信対応）
7. **ヘルプボタンで使用方法を確認**
8. **顧客管理で部署・担当者を管理**
9. **利用規約に同意してから利用開始**（表示対象の最適化）
10. **ファイル添付でメール送信も可能**
11. **寄付機能でプラグイン開発をサポート**

---

## 管理タブの詳細

### 1. 仕事リストタブ
- 受注案件の一覧表示・検索・フィルタリング機能
- 進捗状況による絞り込み
- 顧客名・案件名での検索
- 納期・金額でのソート
- ページネーション機能

### 2. 伝票処理タブ
- 受注書・請求書の作成・編集
- PDF出力機能（個別・一括対応）
- サービス選択ポップアップ
- スタッフチャット機能
- ファイル添付機能

### 3. 顧客タブ
- 顧客情報の登録・編集・削除
- 部署・担当者管理
- 顧客別の受注履歴表示
- 検索・ソート・ページネーション

### 4. サービスタブ
- サービス・商品の登録・編集・削除
- 価格・数量・単位管理
- カテゴリー別管理
- 検索・ソート・ページネーション

### 5. 協力会社タブ
- 協力会社情報の登録・編集・削除
- 職能・スキル管理
- 協力会社別の案件履歴
- 検索・ソート・ページネーション

### 6. レポートタブ
- 月別売上レポート
- 進捗状況の統計
- グラフ表示機能
- データエクスポート機能

---

## スタッフチャット機能
- リアルタイムメッセージ送信（AJAX対応）
- 自動スクロール機能
- キーボードショートカット（Ctrl+Enter）
- メッセージ削除連動機能
- ログイン中スタッフのアバター表示

---

## 部署管理機能
- 顧客ごとの部署・担当者管理
- 部署別のメールアドレス設定
- 請求書への部署情報反映
- 部署の追加・編集・削除機能

---

## 利用規約管理機能
- 利用規約の同意ダイアログ表示
- 管理画面での利用規約編集
- 利用規約バージョン管理
- 同意状態の追跡

---

## シンプル更新システム
- WordPress標準の更新システムに完全対応
- 軽量で安定性を重視した設計
- 自動マイグレーション機能搭載

---

## ページネーション機能
- 全タブでの統一されたページネーション
- サービス選択ポップアップ対応
- 一般設定による表示件数制御
- レスポンシブデザイン対応

---

## ファイル添付機能
- ドラッグ&ドロップによるファイル添付
- 複数ファイル同時添付（最大50MB）
- 対応形式：PDF、画像、Office文書、圧縮ファイル
- 自動クリーンアップ機能
- リアルタイムプレビュー

---

## 完了日自動設定機能
- 進捗ステータス変更時の自動処理
- 完了時の自動日付設定
- 受注以前への変更時の自動クリア
- 仕事リスト・受注書詳細両対応

---

## 納期警告機能
- 期限間近の案件への警告マーク表示
- リアルタイム更新対応
- ツールチップでの残り日数表示

---

## 商品管理機能
- 商品名・単価・数量・単位の管理
- DECIMAL型による精密な価格計算
- デフォルト値設定（数量：1、単位：式）
- インデックス最適化によるパフォーマンス向上
- データマイグレーション機能（職能→商品管理への移行）

---

## スタッフアバター表示機能
- ログイン中スタッフのアバター一覧表示
- 現在のユーザーを強調表示
- レスポンシブデザイン対応
- ツールチップでユーザー名表示
- セッション管理との連携

---

## プラグインリファレンス機能
- 包括的なヘルプシステム
- 機能別詳細ガイド
- トラブルシューティング情報
- キャッシュ機能付きの高速表示
- モーダルベースの使いやすいUI

---

## 寄付機能
- Stripe決済による安全な寄付システム
- 複数の寄付金額オプション
- 寄付進捗のリアルタイム表示
- 寄付完了後の自動メール送信
- 管理画面での寄付履歴確認
- フロントエンド通知システム

---

## 自動マイグレーション機能
- データベース更新の自動化
- 安全なデータ移行
- バージョン管理による段階的更新
- エラーハンドリングとロールバック機能

---

## データベース整合性チェック機能
- データ品質の自動チェック
- 不整合データの検出と修復
- 定期的な整合性確認
- データベースパフォーマンスの最適化

---

## 消費税対応機能
- 軽減税率（8%・10%）対応
- 内税・外税の管理
- 税区分ラベルの統一
- 消費税計算ロジックの最適化
- 請求書・受注書での消費税表示改善

## パフォーマンス最適化機能
- **キャッシュシステム**（トランジェント・オブジェクトキャッシュ）
- **データベースクエリ最適化**（インデックス・JOIN最適化）
- **メモリ使用量最適化**（効率的なデータ構造）
- **画像最適化**（WebP変換・圧縮）
- **JavaScript最適化**（非同期読み込み・バンドル化）
- **CSS最適化**（不要なスタイル削除・圧縮）
- **セッション管理最適化**（自動クローズ・メモリ効率化）
- **Ajax通信最適化**（バッチ処理・レスポンス圧縮）
- **フック管理最適化**（不要なフックの削除・条件付き登録）

---

## 協力会社職能選択の改善
- **ページネーション対応**（大量の職能データの効率的な表示）
- **検索・ソート機能**（職能名・単価・頻度での絞り込み・並び替え）
- **税率対応**（軽減税率・税区分の管理）
- **レスポンシブデザイン**（モバイル・タブレット対応）
- **リアルタイム更新**（職能データの動的読み込み）
- **ユーザビリティ向上**（直感的な選択インターフェース）

---

## アイコンのSVG化
- **Material SymbolsからSVGアイコンへの完全移行**
- **軽量で高速なアイコン表示**（外部フォントの読み込み不要）
- **カスタマイズ可能なアイコンデザイン**（色・サイズ・スタイルの自由な変更）
- **アクセシビリティの向上**（aria-label・role属性の適切な設定）
- **外部依存関係の削除**（Google Fontsへの依存を解消）
- **高解像度ディスプレイ対応**（ベクター形式による鮮明な表示）

## 進捗アイコンのSVG化
- **仕事リストタブの進捗フィルターボタンのアイコンをSVG化**
- **軽量で高速なアイコン表示**（外部フォントの読み込み不要）
- **カスタマイズ可能なアイコンデザイン**（色・サイズ・スタイルの自由な変更）
- **アクセシビリティの向上**（aria-label・role属性の適切な設定）
- **外部依存関係の削除**（Google Fontsへの依存を解消）
- **高解像度ディスプレイ対応**（ベクター形式による鮮明な表示）

## 消費税対応の改善
- **税率計算ロジックの最適化**（精度向上・パフォーマンス改善）
- **消費税表示の改善**（内税・外税の明確な表示）
- **内税・外税の管理強化**（顧客別設定の改善）
- **軽減税率対応の安定化**（8%・10%の正確な計算）
- **請求書・受注書での消費税表示改善**（税率別集計の最適化）

---

## 受注書のコスト項目更新処理の改善
- **リアルタイム自動保存機能の強化**（フィールド変更時の即座な保存）
- **値の変更検知による効率的なデータベース更新**（実際に変更があった場合のみ更新）
- **包括的なエラーハンドリングとログ出力**（デバッグ情報の詳細記録）
- **セキュリティ強化**（nonce検証・権限チェック・入力サニタイズ）
- **データ型の適切な処理**（数値・文字列・NULL値の型別処理）
- **税率フィールドの改善**（空文字・null・0の適切な処理）
- **備考欄の改善**（「0」の場合は空文字列として処理）
- **成功通知の条件付き表示**（実際に値が変更された場合のみ通知）
- **Ajax通信の最適化**（タイムアウト設定・レスポンス処理の改善）

---

## 受注書のコスト項目発注メールの改善
- **適格請求書番号の表示機能**（協力会社の適格請求書番号をメール本文に含める）
- **詳細な税額内訳の表示**（税率別の税額計算と表示）
- **計算根拠の明示**（適格請求書対象・対象外の金額内訳を表示）
- **協力会社別フィルタリング**（特定の協力会社向けの発注内容のみを抽出）
- **発注メールポップアップ機能**（モーダルウィンドウでの送信）
- **リアルタイム内容生成**（AJAXで発注メール内容を動的に取得）
- **添付ファイル対応**（複数ファイルの添付機能）
- **送信状況表示**（送信中の状態表示とエラーハンドリング）
- **情報表示の改善**（発注情報、金額内訳、適格請求書の有無を視覚的に表示）

---

## 変更履歴
### Version 1.2.0(preview) - 2025年8月2日
- **ライセンス設定の廃止**

### Version 1.0.9(a) - 2025年8月2日
- **ダミーデータツールの改善**

### Version 1.0.7(a) - 2025年8月1日
- **ダミーデータツールの改善**
- **詳細タイトルの表示改善**

### Version 1.0.4(a) - 2025年7月31日
- **レポート機能の追加・改善**
  - 売上レポート機能の実装
  - 顧客レポート機能の実装
  - サービスレポート機能の実装
  - 協力会社レポート機能の実装
  - 期間別分析機能の実装
  - グラフ表示機能の実装（Chart.js対応）
  - データエクスポート機能の実装
  - ライセンス認証連携機能の実装
  - レポートセレクター機能の実装
  - リアルタイムデータ更新機能の実装

### Version 1.0.2(a) - 2025年7月30日
* ダミーデーターツール改善

### Version 1.0.1(a) - 2025年7月30日
* ダミーデーターツール実装
* 基本的レポート機能実装

### Version 1.0.0(a) - 2025年7月29日
* ktpa開発開始

### 1.1.23(preview) - 2025年7月28日
* 更新チェック問題テスト
  - 更新システムの安定性向上
  - バグ修正・パフォーマンス最適化
  - 更新チェック機能の改善

### 1.1.22(preview) - 2025年7月28日
* 部署選択エラーの修正
  - 部署選択時のエラーハンドリング強化
  - 部署データの整合性チェック機能追加
  - 部署選択UIの安定性向上
  - 部署関連のデータベース処理最適化
  - 部署管理機能の全体的な改善

### 1.1.17(preview) - 2025年7月28日
* モバイル表示の改善
  - レスポンシブデザインの強化（ブレークポイント最適化・フレキシブルレイアウト）
  - タッチ操作の最適化（タップターゲットサイズ拡大・スワイプジェスチャー対応）
  - モバイル専用UI改善（ナビゲーション・ボタン配置・フォントサイズ調整）
  - パフォーマンス最適化（モバイル向け画像最適化・CSS/JS軽量化）
  - アクセシビリティ向上（スクリーンリーダー対応・キーボードナビゲーション改善）

### 1.1.16(preview) - 2025年7月27日
* 軽微な修正
  - バージョン通知番号の修正

### 1.1.15(preview) - 2025年7月26日
* 利用規約の表示対象を修正（より適切な対象への変更）
* マイグレーション中にエラー解消（データベース更新処理の安定化・エラーハンドリング強化）

### 1.1.13(preview) - 2025年7月25日
* パフォーマンスの向上
  - キャッシュシステムの最適化（トランジェント・オブジェクトキャッシュ）
  - データベースクエリの効率化（インデックス・JOIN最適化）
  - メモリ使用量の最適化（効率的なデータ構造）
  - 画像最適化（WebP変換・圧縮）
  - JavaScript・CSSの最適化（非同期読み込み・バンドル化・圧縮）
  - セッション管理の最適化（自動クローズ・メモリ効率化）
  - Ajax通信の最適化（バッチ処理・レスポンス圧縮）
  - フック管理の最適化（不要なフックの削除・条件付き登録）

### 1.1.12(preview) - 2025年7月24日
* 請求書プレビューが閉じない問題を修正

### 1.1.11(preview) - 2025年7月23日
* 受注書のコスト項目発注メールの改善（適格請求書対応・詳細な税額内訳・計算根拠明示）
* 受注書のコスト項目更新処理の改善（リアルタイム保存・値変更検知・エラーハンドリング強化）

### 1.1.10(preview) - 2025年7月22日
* 受注書のコスト項目更新処理の改善
  - リアルタイム自動保存機能の強化
  - 値の変更検知による効率的なデータベース更新
  - 包括的なエラーハンドリングとログ出力
  - セキュリティ強化（nonce検証・権限チェック）
  - データ型の適切な処理（数値・文字列・NULL値）
  - 税率フィールドの改善（空文字・null・0の適切な処理）
  - 備考欄の改善（「0」の場合は空文字列として処理）
  - 成功通知の条件付き表示（実際に値が変更された場合のみ）
  - Ajax通信の最適化（タイムアウト設定・レスポンス処理）

### 1.1.9(preview) - 2025年7月22日
* 受注書の請求項目更新処理の改善
  - リアルタイム自動保存機能の強化
  - 値の変更検知による効率的なデータベース更新
  - 包括的なエラーハンドリングとログ出力
  - セキュリティ強化（nonce検証・権限チェック）
  - データ型の適切な処理（数値・文字列・NULL値）
  - 税率フィールドの改善（空文字・null・0の適切な処理）
  - 備考欄の改善（「0」の場合は空文字列として処理）
  - 成功通知の条件付き表示（実際に値が変更された場合のみ）
  - Ajax通信の最適化（タイムアウト設定・レスポンス処理）

### 1.1.8(preview) - 2025年7月22日
* 仕事リストタブの進捗アイコンのSVG化
  - 進捗フィルターボタンのアイコンをSVG化
  - 軽量で高速なアイコン表示
  - カスタマイズ可能なアイコンデザイン
  - アクセシビリティの向上
  - 外部依存関係の削除
* 消費税対応の改善
  - 税率計算ロジックの最適化
  - 消費税表示の改善
  - 内税・外税の管理強化
  - 軽減税率対応の安定化

### 1.1.7(preview) - 2025年7月19日
* アイコンのSVG化
  - Material SymbolsからSVGアイコンへの完全移行
  - 軽量で高速なアイコン表示
  - カスタマイズ可能なアイコンデザイン
  - アクセシビリティの向上
  - 外部依存関係の削除

### 1.1.6(preview) - 2025年7月19日
* 協力会社職能選択の改善
  - ページネーション機能の追加
  - 検索・ソート機能の強化
  - 税率対応の改善
  - レスポンシブデザインの最適化
  - ユーザビリティの向上

### 1.1.5(preview) - 2025年7月18日
* パフォーマンス最適化機能の追加
  - キャッシュシステムの改善
  - クエリ最適化の強化
  - メモリ効率化の実装

### 1.1.4(preview) - 2025年7月17日
* 消費税対応機能の強化
  - 軽減税率対応の改善
  - 税区分ラベルの統一
  - 消費税計算ロジックの最適化

### 1.1.3(preview) - 2025年7月16日
* データベース整合性チェック機能の追加
  - データ品質の自動チェック
  - 不整合データの検出と修復
  - 定期的な整合性確認

### 1.1.2(preview) - 2025年7月15日
* 自動マイグレーション機能の実装
  - データベース更新の自動化
  - 安全なデータ移行
  - バージョン管理による段階的更新

### 1.1.1(preview) - 2025年7月14日
* 寄付機能の追加
  - Stripe決済による安全な寄付システム
  - 寄付進捗のリアルタイム表示
  - 寄付完了後の自動メール送信

### 1.1.0(preview) - 2025年7月13日
* プラグインリファレンス機能の実装
  - 包括的なヘルプシステム
  - 機能別詳細ガイド
  - トラブルシューティング情報

### 1.0.9(preview) - 2025年7月12日
* スタッフアバター表示機能の追加
  - ログイン中スタッフの可視化
  - 現在のユーザーを強調表示
  - レスポンシブデザイン対応

### 1.0.6(a) - 2025年8月1日
* ダミーデータツールの改善
* ライセンスキー設定の表示改善

### 1.0.8(preview) - 2025年7月11日
* 商品管理機能の改善
  - DECIMAL型による精密な価格計算
  - データマイグレーション機能
  - インデックス最適化

### 1.0.7(preview) - 2025年7月10日
* 納期警告機能の実装
  - 期限間近の案件への警告表示
  - リアルタイム更新対応
  - ツールチップでの残り日数表示

### 1.0.6(preview) - 2025年7月9日
* 完了日自動設定機能の追加
  - 進捗ステータス変更時の自動処理
  - 完了時の自動日付設定
  - 受注以前への変更時の自動クリア

### 1.0.5(preview) - 2025年7月8日
* ファイル添付機能の実装
  - ドラッグ&ドロップによるファイル添付
  - 複数ファイル同時添付対応
  - 自動クリーンアップ機能

### 1.0.4(preview) - 2025年7月7日
* ページネーション機能の追加
  - 全タブでの統一されたページネーション
  - サービス選択ポップアップ対応
  - 一般設定による表示件数制御

### 1.0.3(preview) - 2025年7月6日
* シンプル更新システムの実装
  - WordPress標準の更新システムに完全対応
  - 軽量で安定性を重視した設計
  - 自動マイグレーション機能搭載

### 1.0.2(preview) - 2025年7月5日
* 利用規約管理機能の追加
  - 利用規約の同意ダイアログ表示
  - 管理画面での利用規約編集
  - 利用規約バージョン管理

### 1.0.1(preview) - 2025年7月4日
* 部署管理機能の実装
  - 顧客ごとの部署・担当者管理
  - 部署別のメールアドレス設定
  - 請求書への部署情報反映

### 1.0.0(preview) - 2025年7月3日
* 初回リリース
  - 6つの管理タブ（仕事リスト・伝票処理・顧客・サービス・協力会社・レポート）
  - 受注案件の進捗管理
  - 受注書・請求書の作成・編集・PDF保存
  - スタッフチャット機能
  - モバイル対応UI
  - セキュリティ機能
  - セッション管理最適化

---

## よくある質問

**Q: プラグインの動作が重い場合は？**
A: パフォーマンス最適化機能により、キャッシュシステムやデータベースクエリの最適化が自動的に行われます。それでも重い場合は、サーバーのメモリ設定を確認してください。

**Q: モバイルで表示が崩れる場合は？**
A: gap→margin対応により、iOS/Android実機での表示崩れを防止しています。最新のブラウザを使用してください。

**Q: データベースエラーが発生した場合は？**
A: 自動マイグレーション機能により、データベースの更新が自動的に行われます。プラグインを再有効化してください。

**Q: セキュリティは大丈夫ですか？**
A: XSS・CSRF・SQLインジェクション対策、ファイルアップロード検証、権限管理など、包括的なセキュリティ機能を実装しています。

---

## スクリーンショット

1. 管理タブ画面
2. 受注書編集画面
3. スタッフチャット画面
4. モバイル対応画面
5. レポート画面

---



---

## アップグレード通知

プラグインの更新は、WordPress標準の更新システムで自動的に通知されます。

## 最終更新日
2025年8月1日